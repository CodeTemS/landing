---
import rutas from "../data/rutas.json";

const ciudades = [...new Set(rutas.flatMap(r => [r.origen, r.destino]))];
---

<div class="w-full flex flex-col items-center p-6">
  <!-- Formulario -->
  <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-6 space-y-4">
    <h2 class="text-xl font-bold text-gray-800">Encuentra tu viaje</h2>

    <div class="flex flex-col space-y-3">
      <!-- Select Origen -->
      <select id="origen" class="p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
        <option value="">Selecciona Origen</option>
        {ciudades.map(c => <option value={c}>{c}</option>)}
      </select>

      <!-- Select Destino -->
      <select id="destino" class="p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500">
        <option value="">Selecciona Destino</option>
      </select>

      <p id="error-msg" class="text-sm text-red-500 hidden">Selecciona origen y destino.</p>
    </div>

    <button id="buscar-btn" class="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors duration-300">
      Buscar
    </button>
  </div>

  <!-- Lista de horarios -->
  <div id="lista-horarios" class="w-full max-w-lg mt-6 space-y-3"></div>
</div>

<style>
.fade-in { animation: fadeIn 0.35s ease-out forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  // ✅ Astro inyecta el JSON en JS
  const rutas = JSON.parse(`{JSON.stringify(rutas)}`);

  const origenSelect = document.getElementById('origen');
  const destinoSelect = document.getElementById('destino');
  const buscarBtn = document.getElementById('buscar-btn');
  const listaHorarios = document.getElementById('lista-horarios');
  const errorMsg = document.getElementById('error-msg');

  // Cuando cambia el origen → llenar destinos válidos
  origenSelect.addEventListener('change', () => {
    const origen = origenSelect.value;
    listaHorarios.innerHTML = '';
    destinoSelect.innerHTML = '<option value="">Selecciona Destino</option>';

    if (!origen) return;

    const destinos = rutas
      .filter(r => r.origen === origen)
      .map(r => r.destino);

    destinos.forEach(destino => {
      const opt = document.createElement('option');
      opt.value = destino;
      opt.textContent = destino;
      destinoSelect.appendChild(opt);
    });
  });

  // Buscar horarios
  buscarBtn.addEventListener('click', () => {
    const origen = origenSelect.value;
    const destino = destinoSelect.value;

    if (!origen || !destino) {
      errorMsg.classList.remove('hidden');
      setTimeout(() => errorMsg.classList.add('hidden'), 3000);
      listaHorarios.innerHTML = '';
      return;
    }

    const ruta = rutas.find(r => r.origen === origen && r.destino === destino);
    listaHorarios.innerHTML = '';

    if (ruta?.horarios?.length) {
      ruta.horarios.forEach(h => {
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg fade-in';
        div.innerHTML = `<span class="font-medium">${h.hora}</span>
                         <span class="text-sm text-gray-500">${h.servicio}</span>
                         <span class="font-bold text-blue-600">$${h.precio}</span>`;
        listaHorarios.appendChild(div);
      });
    } else {
      listaHorarios.innerHTML = '<p class="text-gray-600">No hay horarios disponibles para esta ruta.</p>';
    }
  });
});
</script>
